<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FMAP - Farcaster Map NFT (Updated)</title>
  
  <!-- Farcaster Mini App Meta Tags (Correct Format) -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://fmap-nft.vercel.app/og-image.png","button":{"title":"üé® Mint NFT","action":{"type":"launch_frame","name":"FMAP - Farcaster Map","url":"https://fmap-nft.vercel.app","splashImageUrl":"https://fmap-nft.vercel.app/og-image.png","splashBackgroundColor":"#000000"}}}' />
  
  <!-- Open Graph Tags (Fallback) -->
  <meta property="og:title" content="FMAP - Farcaster Map NFT" />
  <meta property="og:description" content="Mint your on-chain generated pixel art NFT on Base. 10K supply, $0.25 each!" />
  <meta property="og:image" content="https://fmap-nft.vercel.app/og-image.png" />
  <meta property="og:url" content="https://fmap-nft.vercel.app" />

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="FMAP - Farcaster Map NFT" />
  <meta name="twitter:description" content="Mint your on-chain pixel art NFT on Base" />
  <meta name="twitter:image" content="https://fmap-nft.vercel.app/twitter-image.png" />
  <meta name="twitter:creator" content="@ega_2ez4crypto" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* (styles unchanged from original to keep UI identical) */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
    body { background: #000; color: #fff; overflow-x: hidden; }
    .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    .star { position: absolute; background: white; border-radius: 50%; animation: pulse 2s infinite; opacity: 0.6; }
    @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    .gradient-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(147, 51, 234, 0.2) 0%, transparent 50%, rgba(59, 130, 246, 0.2) 100%); pointer-events: none; z-index: 2; }
    .container { position: relative; z-index: 10; }
    header { border-bottom: 1px solid #1f2937; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #a855f7, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; }
    .logo-text { font-size: 1.5rem; font-weight: 900; letter-spacing: 0.05em; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; color: white; }
    .btn-primary { background: linear-gradient(90deg, #9333ea, #3b82f6); }
    .btn-primary:hover { transform: scale(1.05); }
    .wallet-info { padding: 0.5rem 1rem; background: #1f2937; border: 1px solid #374151; border-radius: 8px; font-size: 0.875rem; display: none; }
    .wallet-label { color: #9ca3af; }
    main { max-width: 1000px; margin: 0 auto; padding: 4rem 1.5rem; }
    .hero { text-align: center; margin-bottom: 3rem; }
    .hero-title { font-size: 4rem; font-weight: 900; margin-bottom: 1rem; background: linear-gradient(90deg, #c084fc, #f472b6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 2s infinite; }
    .hero-subtitle { font-size: 1.25rem; color: #9ca3af; margin-bottom: 0.5rem; }
    .hero-desc { color: #6b7280; }
    .nft-preview { display: flex; justify-content: center; margin-bottom: 3rem; }
    .nft-frame { width: 256px; height: 256px; background: linear-gradient(135deg, #581c87, #1e3a8a, #831843); border-radius: 16px; padding: 4px; }
    .nft-inner { width: 100%; height: 100%; background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .pixel-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; padding: 1rem; }
    .pixel { width: 16px; height: 16px; border-radius: 2px; animation: pulse 2s infinite; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 3rem; }
    .stat-card { background: rgba(17, 24, 39, 0.5); backdrop-filter: blur(10px); border: 1px solid #1f2937; border-radius: 12px; padding: 1.5rem; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; }
    .stat-label { font-size: 0.875rem; color: #9ca3af; }
    .mint-section { background: rgba(17, 24, 39, 0.5); backdrop-filter: blur(10px); border: 1px solid #1f2937; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
    .section-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 1.5rem; text-align: center; }
    .mint-controls { max-width: 448px; margin: 0 auto; }
    .amount-control { margin-bottom: 1.5rem; }
    .amount-label { display: block; font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem; }
    .amount-input-group { display: flex; align-items: center; gap: 1rem; }
    .amount-btn { width: 48px; height: 48px; background: #1f2937; border: none; border-radius: 8px; font-size: 1.25rem; font-weight: 700; color: white; cursor: pointer; transition: background 0.3s; }
    .amount-btn:hover { background: #374151; }
    .amount-input { flex: 1; height: 48px; background: #1f2937; border: 1px solid #374151; border-radius: 8px; text-align: center; font-size: 1.5rem; font-weight: 700; color: white; font-family: 'JetBrains Mono', monospace; }
    .amount-input:focus { outline: none; border-color: #9333ea; }
    .cost-info { background: rgba(31, 41, 55, 0.5); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
    .cost-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .cost-row:last-child { margin-bottom: 0; }
    .cost-label { color: #9ca3af; }
    .cost-value { font-weight: 700; }
    .btn-mint { width: 100%; padding: 1rem; background: linear-gradient(90deg, #9333ea, #3b82f6); border: none; border-radius: 12px; font-size: 1.125rem; font-weight: 900; color: white; cursor: pointer; transition: all 0.3s; }
    .btn-mint:hover:not(:disabled) { transform: scale(1.05); }
    .btn-mint:disabled { background: linear-gradient(90deg, #374151, #1f2937); cursor: not-allowed; }
    .status-message { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .status-success { background: rgba(5, 150, 105, 0.5); border: 1px solid #059669; }
    .status-error { background: rgba(220, 38, 38, 0.5); border: 1px solid #dc2626; }
    .status-info { background: rgba(37, 99, 235, 0.5); border: 1px solid #2563eb; }
    .contract-info { background: rgba(17, 24, 39, 0.5); backdrop-filter: blur(10px); border: 1px solid #1f2937; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
    .info-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; font-size: 0.875rem; }
    .info-label { color: #9caaf; }
    .info-value { font-weight: 700; }
    .info-link { display: flex; align-items: center; gap: 0.25rem; color: #a855f7; text-decoration: none; font-family: monospace; }
    .info-link:hover { color: #c084fc; }
    footer { border-top: 1px solid #1f2937; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); padding: 1.5rem; text-align: center; }
    .footer-label { color: #9ca3af; margin-bottom: 0.5rem; }
    .footer-link { display: inline-flex; align-items: center; gap: 0.5rem; color: #60a5fa; text-decoration: none; font-weight: 700; transition: color 0.3s; }
    .footer-link:hover { color: #93c5fd; }
    .footer-copyright { font-size: 0.75rem; color: #4b5563; margin-top: 1rem; }
    @media (max-width: 768px) {
      .hero-title { font-size: 2.5rem; }
      .stats { grid-template-columns: 1fr; }
      .header-content { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  <div class="gradient-overlay"></div>
  
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">F</div>
          <div class="logo-text">FMAP</div>
        </div>
        <button id="connectBtn" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
            <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
            <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
          </svg>
          Connect Wallet
        </button>
        <div id="walletInfo" class="wallet-info">
          <span class="wallet-label">Connected: </span>
          <span id="walletAddress"></span>
        </div>
      </div>
    </header>
    
    <main>
      <div class="hero">
        <h1 class="hero-title">FARCASTER MAP</h1>
        <p class="hero-subtitle">Pixel Art NFT Collection on Base</p>
        <p class="hero-desc">Join the on-chain community mapping revolution</p>
      </div>
      
      <div class="nft-preview">
        <div class="nft-frame">
          <div class="nft-inner">
            <div class="pixel-grid" id="pixelGrid"></div>
          </div>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" style="color: #a855f7;">
            <span id="totalMinted">0</span>/10000
          </div>
          <div class="stat-label">Minted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: #60a5fa;">$0.25</div>
          <div class="stat-label">Mint Price</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: #f472b6;">10</div>
          <div class="stat-label">Max Per Wallet</div>
        </div>
      </div>
      
      <div class="mint-section">
        <h3 class="section-title">Mint Your FMAP NFT</h3>
        <div class="mint-controls">
          <div class="amount-control">
            <label class="amount-label">Amount (<span id="userMinted">0</span>/10 minted)</label>
            <div class="amount-input-group">
              <button class="amount-btn" id="decreaseBtn">-</button>
              <input type="number" class="amount-input" id="mintAmount" value="1" min="1" max="10">
              <button class="amount-btn" id="increaseBtn">+</button>
            </div>
          </div>
          <div class="cost-info">
            <div class="cost-row">
              <span class="cost-label">Total Cost:</span>
              <span class="cost-value" id="totalCostETH">0.00025 ETH</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">‚âà USD:</span>
              <span class="cost-value" style="color: #10b981;" id="totalCostUSD">$0.25</span>
            </div>
          </div>
          <button class="btn-mint" id="mintBtn" disabled>Mint Now</button>
          <div id="statusMessage" class="status-message"></div>
        </div>
      </div>
      
      <div class="contract-info">
        <h4 class="section-title">Contract Information</h4>
        <div class="info-row">
          <span class="info-label">Network:</span>
          <span class="info-value" style="color: #60a5fa;">Base Mainnet</span>
        </div>
        <div class="info-row">
          <span class="info-label">Contract:</span>
          <a href="https://basescan.org/address/0xf9bb77aA3C2F5e7A3387331aa596269fE5920bF3" target="_blank" class="info-link">
            0xf9bb...0bF3
          </a>
        </div>
        <div class="info-row">
          <span class="info-label">Treasury:</span>
          <a href="https://basescan.org/address/0xb9AE3cDFA1ca0484E24E465Df7F49aDBd175B642" target="_blank" class="info-link" style="color: #10b981;">
            0xb9AE...B642
          </a>
        </div>
        <div class="info-row">
          <span class="info-label">Standard:</span>
          <span class="info-value">ERC-721</span>
        </div>
        <div class="info-row">
          <span class="info-label">Metadata:</span>
          <span class="info-value" style="color: #a855f7;">On-Chain Generated</span>
        </div>
      </div>
    </main>
    
    <footer>
      <p class="footer-label">Created by</p>
      <a href="https://x.com/ega_2ez4crypto" target="_blank" class="footer-link">
        @ega_2ez4crypto
      </a>
      <p class="footer-copyright">¬© 2025 FMAP. All rights reserved.</p>
    </footer>
  </div>

  <script>
    // CONFIG
    const CONTRACT_ADDRESS = '0xf9bb77aA3C2F5e7A3387331aa596269fE5920bF3';
    const MINT_PRICE = 0.00025; // ETH
    const MAX_PER_WALLET = 10;

    // STATE
    let account = null;
    let totalMinted = 0;
    let userMinted = 0;

    // SDK holder
    let farcasterSDK = null;
    let injectedProvider = null; // EIP-1193 provider (either Farcaster's embedded wallet or window.ethereum)

    // Load Farcaster Mini App SDK (if available)
    (async function loadSDK() {
      try {
        const module = await import('https://esm.sh/@farcaster/miniapp-sdk');
        farcasterSDK = module.sdk || module;
        console.log('Farcaster SDK loaded');

        // hide splash if in Farcaster
        if (farcasterSDK && farcasterSDK.actions && typeof farcasterSDK.actions.ready === 'function') {
          try { await farcasterSDK.actions.ready(); } catch(e){ console.debug('ready() call failed', e); }
        }

        // If the SDK exposes a wallet provider, use it
        if (farcasterSDK && farcasterSDK.wallet && typeof farcasterSDK.wallet.getEthereumProvider === 'function') {
          try {
            injectedProvider = await farcasterSDK.wallet.getEthereumProvider();
            console.log('Using Farcaster embedded provider');
          } catch (err) {
            console.warn('Failed to get Farcaster provider, falling back to window.ethereum', err);
          }
        }
      } catch (err) {
        console.log('Farcaster SDK not available; running in standard browser mode');
      }

      // If no embedded provider, fallback to window.ethereum
      if (!injectedProvider && typeof window.ethereum !== 'undefined') injectedProvider = window.ethereum;

      // If provider is available, enable UI
      if (injectedProvider) {
        document.getElementById('mintBtn').disabled = false; // allow mint flow after connect sequence
      }
    })();

    // UI helpers
    function showStatus(type, text) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.className = 'status-message ' + (type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : 'status-info');
      statusEl.style.display = 'flex';
      statusEl.innerText = text;
    }

    function hideStatus() {
      const statusEl = document.getElementById('statusMessage');
      statusEl.style.display = 'none';
    }

    // Stars & pixel grid (unchanged)
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 100; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.width = (Math.random() * 3 + 1) + 'px';
      star.style.height = star.style.width;
      star.style.animationDuration = (Math.random() * 3 + 2) + 's';
      star.style.animationDelay = (Math.random() * 2) + 's';
      starsContainer.appendChild(star);
    }
    const pixelGrid = document.getElementById('pixelGrid');
    for (let i = 0; i < 64; i++) {
      const pixel = document.createElement('div');
      pixel.className = 'pixel';
      pixel.style.backgroundColor = 'hsl(' + ((i * 137.5) % 360) + ', 70%, 50%)';
      pixel.style.animationDelay = (i * 0.02) + 's';
      pixelGrid.appendChild(pixel);
    }

    function updateCost() {
      const amount = parseInt(document.getElementById('mintAmount').value) || 1;
      document.getElementById('totalCostETH').textContent = (MINT_PRICE * amount).toFixed(6) + ' ETH';
      document.getElementById('totalCostUSD').textContent = '$' + (MINT_PRICE * amount * 4000).toFixed(2);
    }

    // CONNECT BUTTON: works with Farcaster embedded wallet (if available) or falls back to injected provider (MetaMask/Coinbase)
    document.getElementById('connectBtn').addEventListener('click', async function() {
      try {
        if (!injectedProvider) {
          alert('No wallet provider detected. Open this page inside Warpcast/Farcaster app or install MetaMask/Coinbase Wallet.');
          return;
        }

        // Make sure provider implements EIP-1193 request
        if (typeof injectedProvider.request !== 'function') {
          alert('Detected provider does not support the standard provider API');
          return;
        }

        // Request accounts from provider
        const accounts = await injectedProvider.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) throw new Error('No accounts returned');
        account = accounts[0];

        // Display UI
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('walletAddress').textContent = account.slice(0, 6) + '...' + account.slice(-4);
        document.getElementById('mintBtn').disabled = false;

        // If provider supports chain inspection / switching, attempt to switch to Base (0x2105)
        try {
          const chainId = await injectedProvider.request({ method: 'eth_chainId' });
          if (chainId !== '0x2105') {
            try {
              await injectedProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] });
            } catch (switchErr) {
              // If chain not found, try to add Base
              if (switchErr && switchErr.code === 4902) {
                await injectedProvider.request({ method: 'wallet_addEthereumChain', params: [{
                  chainId: '0x2105',
                  chainName: 'Base',
                  nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                  rpcUrls: ['https://mainnet.base.org'],
                  blockExplorerUrls: ['https://basescan.org']
                }]});
              }
            }
          }
        } catch (e) {
          console.debug('Chain switch not available on this provider', e);
        }

        // Try to fetch on-chain state (best-effort)
        try {
          const totalMintedData = await injectedProvider.request({ method: 'eth_call', params: [{ to: CONTRACT_ADDRESS, data: '0x5b92ac0d' }, 'latest'] });
          totalMinted = parseInt(totalMintedData, 16) || 0;
          document.getElementById('totalMinted').textContent = totalMinted;

          // user minted (best-effort; if contract uses mapping getter signature differs this may fail)
          const userData = await injectedProvider.request({ method: 'eth_call', params: [{ to: CONTRACT_ADDRESS, data: '0x0ebecd80' + account.slice(2).padStart(64, '0') }, 'latest'] });
          userMinted = parseInt(userData, 16) || 0;
          document.getElementById('userMinted').textContent = userMinted;
        } catch (err) {
          console.debug('Could not read on-chain state, continuing with demo values', err);
        }

      } catch (error) {
        console.error('Connection error:', error);
        alert('Failed to connect wallet: ' + (error.message || error));
      }
    });

    // Amount controls
    document.getElementById('decreaseBtn').addEventListener('click', function() {
      const input = document.getElementById('mintAmount');
      const current = parseInt(input.value) || 1;
      if (current > 1) { input.value = current - 1; updateCost(); }
    });
    document.getElementById('increaseBtn').addEventListener('click', function() {
      const input = document.getElementById('mintAmount');
      const current = parseInt(input.value) || 1;
      const remaining = MAX_PER_WALLET - userMinted;
      if (current < remaining) { input.value = current + 1; updateCost(); }
    });
    document.getElementById('mintAmount').addEventListener('input', updateCost);

    // MINT button: use injectedProvider.request for eth_sendTransaction
    document.getElementById('mintBtn').addEventListener('click', async function() {
      if (!account) { alert('Please connect wallet first!'); return; }
      const amount = parseInt(document.getElementById('mintAmount').value) || 1;
      if (userMinted + amount > MAX_PER_WALLET) { alert('Maximum ' + MAX_PER_WALLET + ' mints per wallet!'); return; }

      const mintBtn = document.getElementById('mintBtn');
      mintBtn.disabled = true;
      showStatus('info', '‚è≥ Preparing transaction...');

      try {
        const valueInWeiHex = '0x' + Math.floor(MINT_PRICE * amount * 1e18).toString(16);
        showStatus('info', '‚è≥ Minting in progress...');

        const txHash = await injectedProvider.request({
          method: 'eth_sendTransaction',
          params: [{ from: account, to: CONTRACT_ADDRESS, value: valueInWeiHex, data: '0xa0712d68' + amount.toString(16).padStart(64, '0') }]
        });

        // Poll receipt (best-effort)
        let receipt = null; let attempts = 0;
        while (!receipt && attempts < 40) {
          await new Promise(r => setTimeout(r, 2000));
          receipt = await injectedProvider.request({ method: 'eth_getTransactionReceipt', params: [txHash] });
          attempts++;
        }

        if (receipt && (receipt.status === '0x1' || receipt.status === 1)) {
          showStatus('success', '‚úÖ Minting successful!');
          userMinted += amount; totalMinted += amount;
          document.getElementById('userMinted').textContent = userMinted;
          document.getElementById('totalMinted').textContent = totalMinted;

          // Provide link (unchanged UI behavior)
          alert('Successfully minted ' + amount + ' FMAP NFT' + (amount > 1 ? 's' : '') + '!\n\nView on BaseScan:\nhttps://basescan.org/tx/' + txHash);

          // --- FARCASTER: open compose composer with suggested text (if available) ---
          try {
            if (farcasterSDK && farcasterSDK.actions && typeof farcasterSDK.actions.composeCast === 'function') {
              // Prefill a friendly cast. The user will still need to confirm/post it.
              const suggestedText = `I just minted ${amount} FMAP NFT${amount>1?'s':''} on Base! Check it out: https://fmap-nft.vercel.app`;
              await farcasterSDK.actions.composeCast({ text: suggestedText, embeds: ['https://fmap-nft.vercel.app'] });
            } else {
              // If not in Farcaster, optionally open a small share modal (browser fallback)
              console.debug('composeCast not available - not in Farcaster context or SDK not loaded');
            }
          } catch (err) {
            console.debug('Failed to open Farcaster composer', err);
          }

        } else {
          throw new Error('Transaction failed or timed out');
        }

      } catch (err) {
        console.error('Mint error:', err);
        if (err && err.message && err.message.includes('user rejected')) showStatus('error', '‚ùå Transaction cancelled');
        else showStatus('error', '‚ùå Minting failed. Please try again.');
      } finally {
        mintBtn.disabled = false;
        setTimeout(hideStatus, 5000);
      }
    });

    // Init cost display
    updateCost();
  </script>
</body>
</html>
